

# services:
#   clickhouse:
#     image: clickhouse/clickhouse-server:latest
#     container_name: clickhouse
#     environment:
      
#       CLICKHOUSE_USER: default
#       CLICKHOUSE_PASSWORD: admin123
#       CLICKHOUSE_DB: ivf_mlops
      
#     ports:
#       - "8123:8123"
#       - "9000:9000"
#     volumes:
#       - clickhouse_data:/var/lib/clickhouse

#   ingestion:
#     container_name: ivf_ingestion
#     build:
#       context: .
#       dockerfile: docker/ingestion/Dockerfile
#     depends_on:
#       - clickhouse
#     volumes:
#       - ./data:/data
#     restart: on-failure

#   training:
#     container_name: ivf_training
#     build:
#       context: .
#       dockerfile: docker/training/Dockerfile
#     depends_on:
#       - clickhouse
#       - ingestion
#     volumes:
#       - ./data:/data
#       - ./models:/models
#     restart: on-failure

#   mlflow:

#     image: ghcr.io/mlflow/mlflow:latest
#     container_name: mlflow
#     environment:
#       - MLFLOW_SERVER_ALLOWED_HOSTS=*
#     command: >
#       mlflow server
#       --backend-store-uri sqlite:///mlflow.db
#       --default-artifact-root /mlflow/artifacts
#       --host 0.0.0.0
#       --port 5000
#     ports:
#       - "5000:5000"
#     volumes:
#       - ./mlflow:/mlflow

#   prediction:
#     build:
#       context: .
#       dockerfile: docker/prediction/Dockerfile
#     depends_on:
#       - clickhouse
#       - mlflow

# volumes:
#   clickhouse_data:





# services:
#   clickhouse:
#     image: clickhouse/clickhouse-server:latest
#     container_name: clickhouse
#     environment:
#       CLICKHOUSE_USER: default
#       CLICKHOUSE_PASSWORD: admin123
#       CLICKHOUSE_DB: ivf_mlops
#     ports:
#       - "8123:8123"
#       - "9000:9000"
#     volumes:
#       - clickhouse_data:/var/lib/clickhouse

#   mlflow:
#     image: ghcr.io/mlflow/mlflow:latest
#     container_name: mlflow
#     ports:
#       - "5000:5000"
#     volumes:
#       - ./mlflow:/mlflow
#     command: >
#       mlflow server
#       --backend-store-uri sqlite:///mlflow/mlflow.db
#       --default-artifact-root /mlflow/artifacts
#       --host 0.0.0.0
#       --allowed-hosts "*"

#   ingestion:
#     container_name: ivf_ingestion
#     build:
#       context: .
#       dockerfile: docker/ingestion/Dockerfile
#     depends_on:
#       - clickhouse
#     volumes:
#       - ./data:/data
#     environment:
#       - CLICKHOUSE_HOST=clickhouse
#       - CLICKHOUSE_PORT=8123
#     restart: on-failure

#   training:
#     container_name: ivf_training
#     build:
#       context: .
#       dockerfile: docker/training/Dockerfile
#     depends_on:
#       - clickhouse
#       - mlflow
#       - ingestion
#     volumes:
#       - ./data:/data
#       - ./models:/models
#     environment:
#       - MLFLOW_TRACKING_URI=http://mlflow:5000
#     restart: on-failure

#   prediction:
#     container_name: ivf_prediction
#     build:
#       context: .
#       dockerfile: docker/prediction/Dockerfile
#     depends_on:
#       - clickhouse
#       - mlflow
#     environment:
#       - MLFLOW_TRACKING_URI=http://mlflow:5000
#     restart: on-failure

# volumes:
#   clickhouse_data:







version: "3.9"

services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    environment:
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: admin123
      CLICKHOUSE_DB: ivf_mlops
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse

  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    container_name: mlflow
    ports:
      - "5000:5000"
    volumes:
      # Backend store (runs, experiments)
      - ./mlflow:/mlflow
      # ðŸ”¥ SHARED ARTIFACT STORE (THIS FIXES YOUR ISSUE)
      - ./mlflow_artifacts:/mlflow/artifacts
    command: >
      mlflow server
      --backend-store-uri sqlite:///mlflow/mlflow.db
      --default-artifact-root file:/mlflow/artifacts
      --host 0.0.0.0
      --allowed-hosts "*"

  ingestion:
    container_name: ivf_ingestion
    build:
      context: .
      dockerfile: docker/ingestion/Dockerfile
    depends_on:
      - clickhouse
    volumes:
      - ./data:/data
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
    restart: on-failure

  training:
    container_name: ivf_training
    build:
      context: .
      dockerfile: docker/training/Dockerfile
    depends_on:
      - clickhouse
      - mlflow
      - ingestion
    volumes:
      - ./data:/data
      - ./models:/models
      # ðŸ”¥ SAME ARTIFACT VOLUME
      - ./mlflow_artifacts:/mlflow/artifacts
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    restart: on-failure

  prediction:
    container_name: ivf_prediction
    build:
      context: .
      dockerfile: docker/prediction/Dockerfile
    depends_on:
      - clickhouse
      - mlflow
    volumes:
      # ðŸ”¥ SAME ARTIFACT VOLUME
      - ./mlflow_artifacts:/mlflow/artifacts
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    restart: on-failure

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "8000:8000"
    depends_on:
      - mlflow
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    volumes:
      - ./mlflow_artifacts:/mlflow/artifacts   # ðŸ‘ˆ THIS LINE FIXES EVERYTHING

volumes:
  clickhouse_data:
